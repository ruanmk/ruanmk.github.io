<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="阮明康">
<meta property="og:url" content="http://tensors.space/page/4/index.html">
<meta property="og:site_name" content="阮明康">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阮明康">





  
  
  <link rel="canonical" href="http://tensors.space/page/4/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>阮明康</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">阮明康</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">TENSORS SPACE | 张量空间</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>Sitemap</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tensors.space/2018/10/网络爬虫SCRAPY爬取GOOGLE-PLAY-APPS/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阮明康">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阮明康">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/网络爬虫SCRAPY爬取GOOGLE-PLAY-APPS/" class="post-title-link" itemprop="url">网络爬虫SCRAPY爬取GOOGLE PLAY APPS</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-10-01 21:07:05" itemprop="dateCreated datePublished" datetime="2018-10-01T21:07:05+08:00">2018-10-01</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/系统/" itemprop="url" rel="index"><span itemprop="name">系统</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/系统/系统架构/" itemprop="url" rel="index"><span itemprop="name">系统架构</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Scrapy框架介绍"><a href="#Scrapy框架介绍" class="headerlink" title="Scrapy框架介绍"></a>Scrapy框架介绍</h1><p><img src="/2018/10/网络爬虫SCRAPY爬取GOOGLE-PLAY-APPS/scrapy_architecture_02.png" alt="scrapy架构图"><br>scrapy作为一种可以轻易扩展为分布式的爬虫框架，其内部框架采用类似于消息队列的方式进行任务的调度分发也就不奇怪了，消息队列使得各组件低耦合。至于这个消息队列是存在于单机内存中还是分布式集群中的一个节点，就看业务的需要了。采用生产者-消费者模式进行组织的系统实际上就是三块：任务的生产者，消费者以及消息队列。对应框架图上：<br>生产者：Spiders<br>消费者：Downloader<br>消息队列：Scheduler以及Engine<br>各部分组件由Engine进行驱动，Engine可以看做是一个main函数吧。生产者生产任务（在这里就是要爬取的url）放到消息队列，消费者从消息队列中取得任务进行实际的下载。下载结果交给生产者进行解析，解析结果的一部分是我们要提取的信息，它直接进入Pipeline进行处理，另一部分则是从下载结果中提取的新的任务（url），它将进入消息队列中。整个流程是：</p>
<ul>
<li>(1)一开始Scheduler的队列是空的，所以需要人工hard code一个起始的种子url列表，spider将这些url封装成Request，Engine将这些Request转给Scheduler</li>
<li>(2)与此同时，一旦Scheduler队列非空，Engine将从Scheduler中抽取一个Request给Downloader进行实际下载，Downloader的产出即Response由engine转给spider</li>
<li>(3)Spider抽取Response里面两类信息：第一类就是页面上我们实际要爬取的内容Item，以及这个页面包含的符合要求的url列表。Item由Engine转入Item的深层加工流水线Pipeline，进行进一步的筛选、存储等， url由Spider封装为Request经由Engine交给Scheduler。重复(2)<br>框架图中engine和各组件交换Request和Response的过程中可以插入各种额外的流程，称之为中间件，所以不难想象一共有两种种中间件：Downloader middlewares(对应图中4，5)和 Spider middlewares(对应图中6，7)。除此之外，Item Pipeline中可以插入处理Item的各个步骤。</li></ul>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2018/10/网络爬虫SCRAPY爬取GOOGLE-PLAY-APPS/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tensors.space/2018/10/UBUNTU搭建DEEPSPEECH语音转录系统/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阮明康">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阮明康">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/UBUNTU搭建DEEPSPEECH语音转录系统/" class="post-title-link" itemprop="url">UBUNTU搭建DEEPSPEECH语音转录系统</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-10-01 21:04:57" itemprop="dateCreated datePublished" datetime="2018-10-01T21:04:57+08:00">2018-10-01</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/系统/" itemprop="url" rel="index"><span itemprop="name">系统</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/系统/环境配置/" itemprop="url" rel="index"><span itemprop="name">环境配置</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Mozilla开源了百度的DeepSpeech，实际上模型的关键突破在于既提高了速度，也提高了准确性，其提升来源于RNN的结构设计，还有匹配的并行化方案。开源的版本由于修改了CTCLoss的计算op，因此配置上比较恶心，需要一个特定版本的tensorflow，实际上我们可以通过修改代码，直接将WarpCTC作为一个op动态加载进来。<br>DeepSpeech项目地址： <a href="https://github.com/mozilla/DeepSpeech" target="_blank" rel="noopener">https://github.com/mozilla/DeepSpeech</a><br>Test WarpCTC地址（暂时不会用到）：<a href="https://github.com/baidu-research/warp-ctc" target="_blank" rel="noopener">https://github.com/baidu-research/warp-ctc</a></p>
<p><strong>注意我们这里直接根据DeepSpeech的项目进行部署，不进行任何修改，也不手动引入WarpCTC。</strong></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>在介绍其原理前，我们首先将这个库跑起来。关键步骤实际上都在<a href="https://github.com/mozilla/DeepSpeech/blob/master/README.md" target="_blank" rel="noopener">https://github.com/mozilla/DeepSpeech/blob/master/README.md</a>中，但是由于其采用了一个修改的op，因此还是会出现一些坑。以下安装流程基于 Ubuntu 14.04 x86_64， python 2.7基础上。</p>
<h1 id="使用模型"><a href="#使用模型" class="headerlink" title="使用模型"></a>使用模型</h1><p>1、安装git large file storage<br>各平台的安装说明在<a href="https://github.com/git-lfs/git-lfs/blob/master/INSTALLING.md" target="_blank" rel="noopener">https://github.com/git-lfs/git-lfs/blob/master/INSTALLING.md</a>, 针对Ubuntu 14.04, 执行下面代码即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash</span><br></pre></td></tr></table></figure></p>
<p>2、下载代码<br>安装完git-lfs之后，我们直接clone repo即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/mozilla/DeepSpeech</span><br></pre></td></tr></table></figure></p>
<p>3、下载预训练好的文件（非必要）<br>项目自带了一个英文的语音识别模型，大小为1.2G，可以另开一个线程下载，用于deepspeech的尝试。由于下载时间较长，到这步可以放着下载，先做后面的步骤。</p>
<p>4、创建python虚拟环境<br>（当然也可以装在系统python中）,这里起名字py27，注意要安装virtualenv。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virtualenv py27 --python=python2.7</span><br><span class="line">source py27/bin/activate</span><br></pre></td></tr></table></figure></p>
<p>5、安装deepspeech的python客户端(Python Binding)<br>deepspeech有预编译的二进制文件（也可以自己编译）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install deepspeech</span><br></pre></td></tr></table></figure></p>
<p>到这一步已经能够完成了整个的使用了，具体的使用参数为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deepspeech -h</span><br></pre></td></tr></table></figure></p>
<p>6、安装deepspeech的二进制命令行客户端（python和命令行客户端任选其一即可，只是个客户端程序）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python util/taskcluster.py --target .</span><br></pre></td></tr></table></figure></p>
<p>至此，仅仅使用deepspeech进行inferrence的情况下，配置完成，如果需要训练自己的模型，还需要进行下面的配置。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2018/10/UBUNTU搭建DEEPSPEECH语音转录系统/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tensors.space/2018/05/CPP11/用cmake发布库/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阮明康">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阮明康">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/CPP11/用cmake发布库/" class="post-title-link" itemprop="url">用cmake发布库</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-05-13 19:21:24" itemprop="dateCreated datePublished" datetime="2018-05-13T19:21:24+08:00">2018-05-13</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/语言基础/" itemprop="url" rel="index"><span itemprop="name">语言基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/语言基础/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h1><p>除了用cmake进行库的编译以外，我们还需要掌握如何写一个cmake方便别人在使用我们的库的时候能够顺利链接。<br>本篇仅说明一下整个链接和安装的思路，理清看文档的顺序，其具体的参数和函数签名都有详细的文档的。</p>
<p>首先推荐大家下载这一个Toy Example:<br><a href="https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip" target="_blank" rel="noopener">https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip</a><br>其展示了一个最小的，支持安装以及被其他库find_package的写法。<br>另外可以参考这篇文章，用中文讲述地比较清晰：<br><a href="http://www.yeolar.com/note/2014/12/16/cmake-how-to-find-libraries/" target="_blank" rel="noopener">http://www.yeolar.com/note/2014/12/16/cmake-how-to-find-libraries/</a><br>这里是关于find_package的完整API阐述：<br><a href="https://cmake.org/cmake/help/latest/command/find_package.html#command:find_package" target="_blank" rel="noopener">https://cmake.org/cmake/help/latest/command/find_package.html#command:find_package</a><br>通过本篇文章，咱们希望知道以下目的是怎样达成的：</p>
<ul>
<li>将我们需要对外公布的lib以及header安装在指定的位置</li>
<li>提供多个.cmake脚本（XXConfig.cmake, XXTarget.cmake, XXConfigVersion.cmake）， 使得客户在调用find_package的时候能够成功找到所需库和头文件的位置，这里我们用name来表示库的名字，这相当于设置了以下的变量：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;NAME&gt;_FOUND</span><br><span class="line">&lt;NAME&gt;_INCLUDE_DIRS or &lt;NAME&gt;_INCLUDES</span><br><span class="line">&lt;NAME&gt;_LIBRARIES or &lt;NAME&gt;_LIBRARIES or &lt;NAME&gt;_LIBS</span><br><span class="line">&lt;NAME&gt;_DEFINITIONS</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="find-package做了啥"><a href="#find-package做了啥" class="headerlink" title="find_package做了啥"></a>find_package做了啥</h1><p>为了理解要给find_package提供什么内容，我们首先要理解find_package到底做了哪一些步骤。find_package找库的位置可以分为两种方法：</p>
<ul>
<li><p>模块模式(Module Mode)：查找形如<code>Find&lt;name&gt;.cmake</code>这样的脚本，通过该脚本定义以上的变量。查找的位置有两处：1. 设置的<code>${CMAKE_MODULE_PATH}</code>(由当前CmakeLists.txt脚本或调用命令行等设置)下；2. <code>&lt;CMAKE_ROOT&gt;/Modules/</code> ，比如<code>CMAKE_ROOT=/usr/bin/cmake/share/cmake-3.10</code>, 这个位置保存了cmake认为编程人员常用的库，如lua: FindLua.cmake等。这些路径保留了<code>Find&lt;name&gt;.cmake</code>这样的路径，cmake匹配上后将直接执行，类似于<code>include(Find&lt;name&gt;.cmake)</code>。如果模块模式找不到相应的cmake文件，那么就会启动配置模式，配置模式则比较复杂。</p>
</li>
<li><p>配置模式(Config Mode )</p>
<blockquote>
<p>The CONFIG option, the synonymous NO_MODULE option, or the use of options not specified in the basic signature all enforce pure Config mode. In pure Config mode, the command skips Module mode search and proceeds at once with Config mode search.</p>
</blockquote>
</li>
</ul>
<p>配置模式指定配置所在的位置非常直白，它有一系列的搜索顺序，但是日常我们只需要设置<code>&lt;name&gt;_DIR</code>为包含config的文件夹路径即可。如果<code>&lt;name&gt;_DIR</code>找到了所需的配置文件，那么就会停止搜索，否则会按照顺序进行搜索，可能构造的搜索地址为：</p>
<blockquote>
<p>CMake constructs a set of possible installation prefixes for the package. Under each prefix several directories are searched for a configuration file. The tables below show the directories searched. Each entry is meant for installation trees following Windows (W), UNIX (U), or Apple (A) conventions:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;prefix&gt;/                                                       (W)</span><br><span class="line">&lt;prefix&gt;/(cmake|CMake)/                                         (W)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;*/                                               (W)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;*/(cmake|CMake)/                                 (W)</span><br><span class="line">&lt;prefix&gt;/(lib/&lt;arch&gt;|lib*|share)/cmake/&lt;name&gt;*/                 (U)</span><br><span class="line">&lt;prefix&gt;/(lib/&lt;arch&gt;|lib*|share)/&lt;name&gt;*/                       (U)</span><br><span class="line">&lt;prefix&gt;/(lib/&lt;arch&gt;|lib*|share)/&lt;name&gt;*/(cmake|CMake)/         (U)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;*/(lib/&lt;arch&gt;|lib*|share)/cmake/&lt;name&gt;*/         (W/U)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;*/(lib/&lt;arch&gt;|lib*|share)/&lt;name&gt;*/               (W/U)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;*/(lib/&lt;arch&gt;|lib*|share)/&lt;name&gt;*/(cmake|CMake)/ (W/U)</span><br></pre></td></tr></table></figure></p>
<p>On systems supporting macOS Frameworks and Application Bundles the following directories are searched for frameworks or bundles containing a configuration file:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;prefix&gt;/&lt;name&gt;.framework/Resources/                    (A)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;.framework/Resources/CMake/              (A)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;.framework/Versions/*/Resources/         (A)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;.framework/Versions/*/Resources/CMake/   (A)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;.app/Contents/Resources/                 (A)</span><br><span class="line">&lt;prefix&gt;/&lt;name&gt;.app/Contents/Resources/CMake/           (A)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>这其中<code>&lt;prefix&gt;</code>的变量替换顺序为(其实不用记住这么多，实际上常用的就是<code>&lt;name&gt;_DIR</code>)：</p>
<blockquote>
<ol>
<li>Search paths specified in the <a href="https://cmake.org/cmake/help/latest/variable/PackageName_ROOT.html#variable:%3CPackageName%3E_ROOT" target="_blank" rel="noopener"><code>_ROOT</code></a> CMake variable and the <a href="https://cmake.org/cmake/help/latest/envvar/PackageName_ROOT.html#envvar:%3CPackageName%3E_ROOT" target="_blank" rel="noopener"><code>_ROOT</code></a>environment variable, where <code>&lt;PackageName&gt;</code> is the package to be found. The package root variables are maintained as a stack so if called from within a find module, root paths from the parent’s find module will also be searched after paths for the current package. This can be skipped if <code>NO_PACKAGE_ROOT_PATH</code> is passed. See policy <a href="https://cmake.org/cmake/help/latest/policy/CMP0074.html#policy:CMP0074" target="_blank" rel="noopener"><code>CMP0074</code></a>.</li>
<li><p>Search paths specified in cmake-specific cache variables. These are intended to be used on the command line with a <code>-DVAR=value</code>. The values are interpreted as <a href="https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#cmake-language-lists" target="_blank" rel="noopener">semicolon-separated lists</a>. This can be skipped if <code>NO_CMAKE_PATH</code> is passed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_PREFIX_PATH</span><br><span class="line">CMAKE_FRAMEWORK_PATH</span><br><span class="line">CMAKE_APPBUNDLE_PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>Search paths specified in cmake-specific environment variables. These are intended to be set in the user’s shell configuration, and therefore use the host’s native path separator (<code>;</code> on Windows and <code>:</code> on UNIX). This can be skipped if <code>NO_CMAKE_ENVIRONMENT_PATH</code> is passed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;PackageName&gt;_DIR</span><br><span class="line">CMAKE_PREFIX_PATH</span><br><span class="line">CMAKE_FRAMEWORK_PATH</span><br><span class="line">CMAKE_APPBUNDLE_PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>Search paths specified by the <code>HINTS</code> option. These should be paths computed by system introspection, such as a hint provided by the location of another item already found. Hard-coded guesses should be specified with the <code>PATHS</code> option.</p>
</li>
<li><p>Search the standard system environment variables. This can be skipped if <code>NO_SYSTEM_ENVIRONMENT_PATH</code>is passed. Path entries ending in <code>/bin</code> or <code>/sbin</code> are automatically converted to their parent directories:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>Search paths stored in the CMake <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#user-package-registry" target="_blank" rel="noopener">User Package Registry</a>. This can be skipped if <code>NO_CMAKE_PACKAGE_REGISTRY</code> is passed or by setting the <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_FIND_PACKAGE_NO_PACKAGE_REGISTRY.html#variable:CMAKE_FIND_PACKAGE_NO_PACKAGE_REGISTRY" target="_blank" rel="noopener"><code>CMAKE_FIND_PACKAGE_NO_PACKAGE_REGISTRY</code></a> to <code>TRUE</code>. See the <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#manual:cmake-packages(7" target="_blank" rel="noopener"><code>cmake-packages(7)</code></a>) manual for details on the user package registry.</p>
</li>
<li><p>Search cmake variables defined in the Platform files for the current system. This can be skipped if <code>NO_CMAKE_SYSTEM_PATH</code> is passed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_SYSTEM_PREFIX_PATH</span><br><span class="line">CMAKE_SYSTEM_FRAMEWORK_PATH</span><br><span class="line">CMAKE_SYSTEM_APPBUNDLE_PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>Search paths stored in the CMake <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#system-package-registry" target="_blank" rel="noopener">System Package Registry</a>. This can be skipped if <code>NO_CMAKE_SYSTEM_PACKAGE_REGISTRY</code> is passed or by setting the<a href="https://cmake.org/cmake/help/latest/variable/CMAKE_FIND_PACKAGE_NO_SYSTEM_PACKAGE_REGISTRY.html#variable:CMAKE_FIND_PACKAGE_NO_SYSTEM_PACKAGE_REGISTRY" target="_blank" rel="noopener"><code>CMAKE_FIND_PACKAGE_NO_SYSTEM_PACKAGE_REGISTRY</code></a> to <code>TRUE</code>. See the <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#manual:cmake-packages(7" target="_blank" rel="noopener"><code>cmake-packages(7)</code></a>) manual for details on the system package registry.</p>
</li>
<li>Search paths specified by the <code>PATHS</code> option. These are typically hard-coded guesses.</li>
</ol>
</blockquote>
<p><strong>config的名字只能有这两种形式：<code>&lt;name&gt;Config.cmake</code> 或者 <code>&lt;lower-case-package-name&gt;-config.cmake</code>，一旦设置好<code>&lt;name&gt;_DIR</code>，并且cmake通过这个路径找到了相应的两种形式(之一)的配置文件，就会设置<code>&lt;name&gt;_CONFIG</code>为找到的配置文件(两者之一)的全部路径。</strong></p>
<h1 id="自定义模块config-cmake"><a href="#自定义模块config-cmake" class="headerlink" title="自定义模块config.cmake"></a>自定义模块config.cmake</h1><p>find_package. 不管是配置式还是模块式，最终都是设置相应的库的路径。</p>
<h2 id="模块模式"><a href="#模块模式" class="headerlink" title="模块模式"></a>模块模式</h2><p>下面我们看一下模块式的一个例子：FindMFC.cmake<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># Distributed under the OSI-approved BSD 3-Clause License.  See accompanying</span><br><span class="line"># file Copyright.txt or https://cmake.org/licensing for details.</span><br><span class="line"></span><br><span class="line">#.rst:</span><br><span class="line"># FindMFC</span><br><span class="line"># -------</span><br><span class="line">#</span><br><span class="line"># Find MFC on Windows</span><br><span class="line">#</span><br><span class="line"># Find the native MFC - i.e.  decide if an application can link to the</span><br><span class="line"># MFC libraries.</span><br><span class="line">#</span><br><span class="line"># ::</span><br><span class="line">#</span><br><span class="line">#   MFC_FOUND - Was MFC support found</span><br><span class="line">#</span><br><span class="line"># You don&apos;t need to include anything or link anything to use it.</span><br><span class="line"></span><br><span class="line"># Assume no MFC support</span><br><span class="line">set(MFC_FOUND &quot;NO&quot;)</span><br><span class="line"></span><br><span class="line"># Only attempt the try_compile call if it has a chance to succeed:</span><br><span class="line">set(MFC_ATTEMPT_TRY_COMPILE 0)</span><br><span class="line">if(WIN32 AND NOT UNIX AND NOT BORLAND AND NOT MINGW)</span><br><span class="line">  set(MFC_ATTEMPT_TRY_COMPILE 1)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">if(MFC_ATTEMPT_TRY_COMPILE)</span><br><span class="line">  if(NOT DEFINED MFC_HAVE_MFC)</span><br><span class="line">    set(CHECK_INCLUDE_FILE_VAR &quot;afxwin.h&quot;)</span><br><span class="line">    configure_file($&#123;CMAKE_ROOT&#125;/Modules/CheckIncludeFile.cxx.in</span><br><span class="line">      $&#123;CMAKE_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/CMakeTmp/CheckIncludeFile.cxx)</span><br><span class="line">    message(STATUS &quot;Looking for MFC&quot;)</span><br><span class="line">    # Try both shared and static as the root project may have set the /MT flag</span><br><span class="line">    try_compile(MFC_HAVE_MFC</span><br><span class="line">      $&#123;CMAKE_BINARY_DIR&#125;</span><br><span class="line">      $&#123;CMAKE_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/CMakeTmp/CheckIncludeFile.cxx</span><br><span class="line">      CMAKE_FLAGS</span><br><span class="line">      -DCMAKE_MFC_FLAG:STRING=2</span><br><span class="line">      -DCOMPILE_DEFINITIONS:STRING=-D_AFXDLL</span><br><span class="line">      OUTPUT_VARIABLE OUTPUT)</span><br><span class="line">    if(NOT MFC_HAVE_MFC)</span><br><span class="line">      configure_file($&#123;CMAKE_ROOT&#125;/Modules/CheckIncludeFile.cxx.in</span><br><span class="line">        $&#123;CMAKE_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/CMakeTmp/CheckIncludeFile.cxx)</span><br><span class="line">      try_compile(MFC_HAVE_MFC</span><br><span class="line">        $&#123;CMAKE_BINARY_DIR&#125;</span><br><span class="line">        $&#123;CMAKE_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/CMakeTmp/CheckIncludeFile.cxx</span><br><span class="line">        CMAKE_FLAGS</span><br><span class="line">        -DCMAKE_MFC_FLAG:STRING=1</span><br><span class="line">        OUTPUT_VARIABLE OUTPUT)</span><br><span class="line">    endif()</span><br><span class="line">    if(MFC_HAVE_MFC)</span><br><span class="line">      message(STATUS &quot;Looking for MFC - found&quot;)</span><br><span class="line">      set(MFC_HAVE_MFC 1 CACHE INTERNAL &quot;Have MFC?&quot;)</span><br><span class="line">      file(APPEND $&#123;CMAKE_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/CMakeOutput.log</span><br><span class="line">        &quot;Determining if MFC exists passed with the following output:\n&quot;</span><br><span class="line">        &quot;$&#123;OUTPUT&#125;\n\n&quot;)</span><br><span class="line">    else()</span><br><span class="line">      message(STATUS &quot;Looking for MFC - not found&quot;)</span><br><span class="line">      set(MFC_HAVE_MFC 0 CACHE INTERNAL &quot;Have MFC?&quot;)</span><br><span class="line">      file(APPEND $&#123;CMAKE_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/CMakeError.log</span><br><span class="line">        &quot;Determining if MFC exists failed with the following output:\n&quot;</span><br><span class="line">        &quot;$&#123;OUTPUT&#125;\n\n&quot;)</span><br><span class="line">    endif()</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  if(MFC_HAVE_MFC)</span><br><span class="line">    set(MFC_FOUND &quot;YES&quot;)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure></p>
<h2 id="配置模式"><a href="#配置模式" class="headerlink" title="配置模式"></a>配置模式</h2><p>具体参考<br><a href="https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip" target="_blank" rel="noopener">https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip</a>   关键是提供<code>&lt;name&gt;Config.cmake</code>和<code>&lt;name&gt;ConfigVersion.cmake</code>两个文件，并且在Version中配置<code>PACKAGE_VERSION_COMPATIBLE</code>和<code>PACKAGE_VERSION_EXACT</code>两个变量。</p>
<h1 id="Export及其使用"><a href="#Export及其使用" class="headerlink" title="Export及其使用"></a>Export及其使用</h1><p>我们虽然通过find_package能够定义这些库所在的位置以及头文件的位置，但是需要一种方式将其作为一个target加进来，以用于编译和链接(否则他们只是纯粹的放在内存里的几个变量而已。这些需要通过target脚本来实现，一般target脚本都是和配置模式一起使用的，<code>&lt;name&gt;Config.cmake</code>中常<code>include (&quot;${CMAKE_CURRENT_LIST_DIR}/&lt;name&gt;-target.cmake&quot;)</code>来直接调用target，直白来说，target里面就是添加了这几个库作为target，一个例子如下, 这个脚本是cmake通过export命令生成的，具体可以参考<a href="https://cmake.org/cmake/help/v3.12/command/export.html：" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.12/command/export.html：</a> ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># Generated by CMake</span><br><span class="line"></span><br><span class="line">if(&quot;$&#123;CMAKE_MAJOR_VERSION&#125;.$&#123;CMAKE_MINOR_VERSION&#125;&quot; LESS 2.5)</span><br><span class="line">   message(FATAL_ERROR &quot;CMake &gt;= 2.6.0 required&quot;)</span><br><span class="line">endif()</span><br><span class="line">cmake_policy(PUSH)</span><br><span class="line">cmake_policy(VERSION 2.6)</span><br><span class="line">#----------------------------------------------------------------</span><br><span class="line"># Generated CMake target import file.</span><br><span class="line">#----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># Commands may need to know the format version.</span><br><span class="line">set(CMAKE_IMPORT_FILE_VERSION 1)</span><br><span class="line"></span><br><span class="line"># Protect against multiple inclusion, which would fail when already imported targets are added once more.</span><br><span class="line">set(_targetsDefined)</span><br><span class="line">set(_targetsNotDefined)</span><br><span class="line">set(_expectedTargets)</span><br><span class="line">foreach(_expectedTarget foo bar)</span><br><span class="line">  list(APPEND _expectedTargets $&#123;_expectedTarget&#125;)</span><br><span class="line">  if(NOT TARGET $&#123;_expectedTarget&#125;)</span><br><span class="line">    list(APPEND _targetsNotDefined $&#123;_expectedTarget&#125;)</span><br><span class="line">  endif()</span><br><span class="line">  if(TARGET $&#123;_expectedTarget&#125;)</span><br><span class="line">    list(APPEND _targetsDefined $&#123;_expectedTarget&#125;)</span><br><span class="line">  endif()</span><br><span class="line">endforeach()</span><br><span class="line">if(&quot;$&#123;_targetsDefined&#125;&quot; STREQUAL &quot;$&#123;_expectedTargets&#125;&quot;)</span><br><span class="line">  unset(_targetsDefined)</span><br><span class="line">  unset(_targetsNotDefined)</span><br><span class="line">  unset(_expectedTargets)</span><br><span class="line">  set(CMAKE_IMPORT_FILE_VERSION)</span><br><span class="line">  cmake_policy(POP)</span><br><span class="line">  return()</span><br><span class="line">endif()</span><br><span class="line">if(NOT &quot;$&#123;_targetsDefined&#125;&quot; STREQUAL &quot;&quot;)</span><br><span class="line">  message(FATAL_ERROR &quot;Some (but not all) targets in this export set were already defined.\nTargets Defined: $&#123;_targetsDefined&#125;\nTargets not yet defined: $&#123;_targetsNotDefined&#125;\n&quot;)</span><br><span class="line">endif()</span><br><span class="line">unset(_targetsDefined)</span><br><span class="line">unset(_targetsNotDefined)</span><br><span class="line">unset(_expectedTargets)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Create imported target foo</span><br><span class="line">add_library(foo SHARED IMPORTED)</span><br><span class="line"></span><br><span class="line"># Create imported target bar</span><br><span class="line">add_executable(bar IMPORTED)</span><br><span class="line"></span><br><span class="line"># Import target &quot;foo&quot; for configuration &quot;Debug&quot;</span><br><span class="line">set_property(TARGET foo APPEND PROPERTY IMPORTED_CONFIGURATIONS DEBUG)</span><br><span class="line">set_target_properties(foo PROPERTIES</span><br><span class="line">  IMPORTED_LOCATION_DEBUG &quot;/Users/rmk/Downloads/FooBar/cmake-build-debug/foo/libfoo.dylib&quot;</span><br><span class="line">  IMPORTED_SONAME_DEBUG &quot;/Users/rmk/Downloads/FooBar/cmake-build-debug/foo/libfoo.dylib&quot;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"># Import target &quot;bar&quot; for configuration &quot;Debug&quot;</span><br><span class="line">set_property(TARGET bar APPEND PROPERTY IMPORTED_CONFIGURATIONS DEBUG)</span><br><span class="line">set_target_properties(bar PROPERTIES</span><br><span class="line">  IMPORTED_LOCATION_DEBUG &quot;/Users/rmk/Downloads/FooBar/cmake-build-debug/bar/bar&quot;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"># This file does not depend on other imported targets which have</span><br><span class="line"># been exported from the same project but in a separate export set.</span><br><span class="line"></span><br><span class="line"># Commands beyond this point should not need to know the version.</span><br><span class="line">set(CMAKE_IMPORT_FILE_VERSION)</span><br><span class="line">cmake_policy(POP)</span><br></pre></td></tr></table></figure></p>
<h1 id="生成配置模式所需文件的CMakeLists-txt脚本"><a href="#生成配置模式所需文件的CMakeLists-txt脚本" class="headerlink" title="生成配置模式所需文件的CMakeLists.txt脚本"></a>生成配置模式所需文件的CMakeLists.txt脚本</h1><p>摘自<a href="https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip" target="_blank" rel="noopener">https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># Add all targets to the build-tree export set</span><br><span class="line">export(TARGETS foo bar</span><br><span class="line">  FILE &quot;$&#123;PROJECT_BINARY_DIR&#125;/FooBarTargets.cmake&quot;)</span><br><span class="line"></span><br><span class="line"># Export the package for use from the build-tree</span><br><span class="line"># (this registers the build-tree with a global CMake-registry)</span><br><span class="line">export(PACKAGE FooBar)</span><br><span class="line"></span><br><span class="line"># Create the FooBarConfig.cmake and FooBarConfigVersion files</span><br><span class="line">file(RELATIVE_PATH REL_INCLUDE_DIR &quot;$&#123;INSTALL_CMAKE_DIR&#125;&quot;</span><br><span class="line">   &quot;$&#123;INSTALL_INCLUDE_DIR&#125;&quot;)</span><br><span class="line"># ... for the build tree</span><br><span class="line">set(CONF_INCLUDE_DIRS &quot;$&#123;PROJECT_SOURCE_DIR&#125;&quot; &quot;$&#123;PROJECT_BINARY_DIR&#125;&quot; CACHE PATH &quot;&quot;)</span><br><span class="line">configure_file(FooBarConfig.cmake.in</span><br><span class="line">  &quot;$&#123;PROJECT_BINARY_DIR&#125;/FooBarConfig.cmake&quot; @ONLY)</span><br><span class="line"># ... for the install tree</span><br><span class="line">set(CONF_INCLUDE_DIRS &quot;\$&#123;FOOBAR_CMAKE_DIR&#125;/$&#123;REL_INCLUDE_DIR&#125;&quot;)</span><br><span class="line">configure_file(FooBarConfig.cmake.in</span><br><span class="line">  &quot;$&#123;PROJECT_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/FooBarConfig.cmake&quot; @ONLY)</span><br><span class="line"># ... for both</span><br><span class="line">configure_file(FooBarConfigVersion.cmake.in</span><br><span class="line">  &quot;$&#123;PROJECT_BINARY_DIR&#125;/FooBarConfigVersion.cmake&quot; @ONLY)</span><br><span class="line"></span><br><span class="line"># Install the FooBarConfig.cmake and FooBarConfigVersion.cmake</span><br><span class="line">install(FILES</span><br><span class="line">  &quot;$&#123;PROJECT_BINARY_DIR&#125;$&#123;CMAKE_FILES_DIRECTORY&#125;/FooBarConfig.cmake&quot;</span><br><span class="line">  &quot;$&#123;PROJECT_BINARY_DIR&#125;/FooBarConfigVersion.cmake&quot;</span><br><span class="line">  DESTINATION &quot;$&#123;INSTALL_CMAKE_DIR&#125;&quot; COMPONENT dev)</span><br><span class="line"></span><br><span class="line"># Install the export set for use with the install-tree</span><br><span class="line"># allowing others to include FooBarTargets.cmake</span><br><span class="line">install(EXPORT FooBarTargets DESTINATION</span><br><span class="line">  &quot;$&#123;INSTALL_CMAKE_DIR&#125;&quot; COMPONENT dev)</span><br></pre></td></tr></table></figure></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://www.voidcn.com/article/p-ydfqrabf-ru.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-ydfqrabf-ru.html</a><br><a href="https://gitlab.kitware.com/cmake/community/wikis/doc/tutorials/How-to-create-a-ProjectConfig.cmake-file" target="_blank" rel="noopener">https://gitlab.kitware.com/cmake/community/wikis/doc/tutorials/How-to-create-a-ProjectConfig.cmake-file</a><br><a href="http://www.yeolar.com/note/2014/12/16/cmake-how-to-find-libraries/" target="_blank" rel="noopener">http://www.yeolar.com/note/2014/12/16/cmake-how-to-find-libraries/</a></p>
<p>例子：<a href="https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip" target="_blank" rel="noopener">https://gitlab.kitware.com/cmake/community/uploads/a91192d30ee2df45bd225b08c3a20c1d/FooBar.zip</a><br>export函数: <a href="https://cmake.org/cmake/help/v3.12/command/export.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.12/command/export.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tensors.space/2018/05/由人脸识别引发的Softmax改进/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阮明康">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阮明康">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/由人脸识别引发的Softmax改进/" class="post-title-link" itemprop="url">由人脸识别引发的Softmax改进</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-05-11 19:53:39" itemprop="dateCreated datePublished" datetime="2018-05-11T19:53:39+08:00">2018-05-11</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/理论基础/" itemprop="url" rel="index"><span itemprop="name">理论基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/理论基础/神经网络/" itemprop="url" rel="index"><span itemprop="name">神经网络</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Softmax由于其每个分类正负样本的概率是对称的，使得其类内不够紧凑，针对这一缺点各种文章百花齐放，各种小修小改，其关键目的就是提高inter-class dispension和intra-class compactness.对于close-set的人脸识别任务，现有的分类手段已经能够做得比较好了，但是对于open-set的人脸识别任务，就要求即使是不在训练集里面的人脸，也应该要将同一个人的脸的feature映射到特征空间里一个紧凑的位置从而使得无监督的聚类算法可以介入。这里有一个基本的要求，就是类内的最大距离一定不能大于类间的最小距离，部分文章还额外加上一个margin，也就是类内的最大距离要小于类间的最小距离减去margin，也就是还得留出一定的隔离带。这个要求也被大部分的Siamese类network所接受。open-set的人脸识别实际上是一种metric learning， 学的关键就是这个feature，而不是后面的classifier</p>
<p>下面我们来看看基于改进softmax的每一家具体的方案。<br><strong>注意：以下的x是需要学习的样本的特征表示，是要学习的目的之一啊，不是固定的，我们要学的就是一个可以无监督分类的x，所谓metric learning, 可以理解为固定W学习x然后固定x计算新的W，W对应FC层的权重，x则是这之前的神经网络提取的特征，Wx一般输入到Softmax中，下面的所有推导中，都假设当前W固定，下一步是优化x，并说明为啥这些改动会使得得到的x更加紧凑</strong></p>
<h1 id="CenterLoss-ECCV2016"><a href="#CenterLoss-ECCV2016" class="headerlink" title="CenterLoss (ECCV2016)"></a>CenterLoss (ECCV2016)</h1><p>这是由 <a href="https://kpzhang93.github.io/papers/eccv2016.pdf" target="_blank" rel="noopener">https://kpzhang93.github.io/papers/eccv2016.pdf</a> (A Discriminative Feature Learning Approach for Deep Face Recognition)这篇文章提出的。并且这样类似的方法并不只此一家，softmax + 某种能够强调类内compactness的loss都可以，比如softmax + tripletloss（不实用，好难设计样本对，exmaple mining不好做，训练时直接一步loss为0欠拟合是喜闻乐见的）等等。毕竟属于社会主义初级阶段，依然还是loss之间的排列组合。这篇文章还澄清了一对很重要的概念，那就是separable features和discriminative feature。separable feature可以理解为神经网络fc前最后一层，是线性可分的。而discriminative则不仅要separable，还必须保持类内紧凑，从而方便最近邻聚类等算法进行聚类，以保持对未知类别的可分性。换句话说，给一个不在训练集里面的人脸的多个样本，输出的feature不仅要和库里面的不同，并且这几个额外的样本在特征空间里面是要聚成一团的，可以无监督地得出这是一个新的类别。这样子就使得人脸识别模型在新来一个人的脸后不需要重新进行训练。从close-set的识别能力扩展到了open-set。</p>
<p><img src="/2018/05/由人脸识别引发的Softmax改进/sep-dis.png" alt="sep-dis"></p>
<p>正如其名字所表示的那样，center loss在每一个batch中，对每一类的所有样本的feature算了一个均值，然后损失函数为原softmax（类间差异）+center loss（类内紧凑）。<br>这篇文章开了一个类内紧凑的头，但是缺点是 每个batch都得要预先算一个中心，每个batch中心又是在不断改变的，这就导致了不一定会收敛(实际上作者将centor loss的权重调的比较小所以这个问题在实验中并没有体现出来。</p>
<p><img src="/2018/05/由人脸识别引发的Softmax改进/center-loss.png" alt="center-loss"></p>
<p>这篇文章还有一个副产物，那就是发现softmax的结果总是天然地按照弧度扇形分布，这个结果被后续的文章所使用，并产生了angular margin这么一个新的热词。</p>
<p><img src="/2018/05/由人脸识别引发的Softmax改进/centerloss-softmax.png" alt="centerloss-softmax"></p>
<h1 id="SphereFace-CVPR2017"><a href="#SphereFace-CVPR2017" class="headerlink" title="SphereFace (CVPR2017)"></a>SphereFace (CVPR2017)</h1><p><a href="https://arxiv.org/pdf/1704.08063.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1704.08063.pdf</a><br>首次提出angular margin，不再是之前画个二维散点图然后用直线区分几个分类的那种（Euclidean margin，比如SVM），现在它将样本看做是分布在圆弧(二维)或者高维球面上的点，根据圆（球）心角来区分几个不同的分类。</p>
<p><img src="/2018/05/由人脸识别引发的Softmax改进/sphereface.png" alt="sphereface"></p>
<h2 id="第一阶段-Modified-Softmax也是初步的A-Softmax"><a href="#第一阶段-Modified-Softmax也是初步的A-Softmax" class="headerlink" title="第一阶段 Modified-Softmax也是初步的A-Softmax"></a>第一阶段 Modified-Softmax也是初步的A-Softmax</h2><p>作者提出，softmax的结果虽然很像可以按角度去进行区分，实际上却又不是那么简单（比如上图a在不限制$W$的模长的情况下，样本在特征空间上的分布是不均匀的），于是需要对softmax进行一些修改。<br>为了方便说明，这里以二分类为例，对于原始softmax, 两个类的分界线可以写成：</p>
<script type="math/tex; mode=display">
W_1x+b1=W_2x+b2\Rightarrow (W_1-W_2)x + b_1-b_2=0</script><p>这就是softmax上面的幂指数相等的那个线。在原始的softmax函数中，两个W的模能够对分界线有较大的影响，想象到极限情况下，$\lVert W_1\rVert=+\infty,\lVert W_2\rVert=0$，这时候符合第一类的样本只需要满足$W_1x&gt;0$,bias此时已经变得不重要了。这个条件此时是非常容易满足的，只要不是完全和$W_1$正交就好，也就是$W_1$这边x的空间会摊得非常大，而$W_2$这边就被压缩的几乎看不到了，图b能够稍微看到一些这样的迹象，但是不准确。当然，一个正常训练的样本均衡的模型实际上并不会出现这样的$W$。如图b所示，两个向量的中间位置的夹角，并不能够区分两类样本（稍微调整下位置还是可以的），也就是，这个中心，还不够‘中心’，因为组成这个中心的两边是不平衡的。中心不平衡带来的问题就是，从$W_1$到$W_2$这个扇形里面，每一个单位弧度所包含的样本概率密度是不一样的，靠近$W_1$这边，由于$W_1$的模较大，其对应的同角度的x的模长范围就限制得比较松，或者同等模长的$x$则可以取值的角度范围较大，此时的实际分界线是偏向于模长较短的$W_2$这边的(即留给$W_1$更多位置)，而不是图b中的二分位置。有问题吗？没问题，只是没必要这样而已，如果能够限制两$W$的模长一致，那么就不需要算这个实际的分界点了，直接就是$(W_1+W_2)/2$，也就是角平分线就可以了。<br>为了方便，假如我们限制$\lVert W_1\rVert = \lVert W_2\rVert$,且$b_1=b_2=0$,那么我们有这样的分界线：</p>
<script type="math/tex; mode=display">
\lVert x\rVert (cos(\theta_1)-cos(\theta_2))=0</script><p>这时候学习到的样本空间就能够很好地由角度分开了(毕竟现在就是在直接优化$\theta$啊，能学不到嘛。。。实际上是优化x和W来达到优化$\theta​$的目的)，对应上图d。至此，我们已经能够用angular来替代euclidean softmax了,但是仅仅是替代，依然还没解决类内不紧凑的问题。</p>
<h2 id="第二阶段-增加类内紧凑性后的A-Softmax"><a href="#第二阶段-增加类内紧凑性后的A-Softmax" class="headerlink" title="第二阶段 增加类内紧凑性后的A-Softmax"></a>第二阶段 增加类内紧凑性后的A-Softmax</h2><p>为了进一步分开两类，显然像SVM一样引入一块间隔margin能够增加模型的鲁棒性。这块margin中的样本不会被判断为任何一个类，实际上模型学习到的feature不会映射到这个区间内。看图f，在没有引入m之前，中间的Angular Bisector就是两类的分界线，在分界线的左边，以$W_1$为中心，越往两边其被分为第一类的置信度就越低，在分界线附近分为任何一类的置信度就一样了。要引入一个间隔，实际上就是以angular bisector为中心，在附近引入一块区域，特征落在这块区域中时，既不是第一类，也不是第二类。压缩的办法比较粗暴，那就是在bisector左边压缩$\theta_1$，而在右边压缩$\theta_2$，以左侧为例，引入下式作为判断类1的分界点：</p>
<script type="math/tex; mode=display">
\lVert x\rVert (cos(m\theta_1)-cos(\theta_2))>0</script><p>右侧判断类2的则相应的是：</p>
<script type="math/tex; mode=display">
\lVert x\rVert (cos(m\theta_2)-cos(\theta_1))>0</script><p>看左边对应的公式，这条式子的特别之处就是$\theta_2$是不变的，而使用$m\theta_1$来整体替代之前的$\theta_1$，$m$是一个大于1的数值，这就会压缩$\theta_1$的取值范围，又不影响$\theta_2$,如果此时$\theta_1$靠近bisector附近，那么$\lVert x\rVert (cos(m\theta_1)-cos(\theta_2))&lt;0$, 此时该样本不能被判为类1.同理用一样的方法对另一边进行操作，也会压缩另一个类2的取值范围，类2也会出现一个区域不能被判为2，这段既不能为1也不能为2的区域就组成了我们要的margin.训练过程中落在这些区域的样本由于被梯度往左右两边(拉向$W_1, W_2$)时loss会更少，因此充分训练后，可分的样本都不会出现在这个区域中。</p>
<h1 id="CosFace"><a href="#CosFace" class="headerlink" title="CosFace"></a>CosFace</h1><p>cosface的想法也是比较类似的，但是m放的位置不同，它采用的是：</p>
<script type="math/tex; mode=display">
\lVert x\rVert (cos(\theta_1)-m-cos(\theta_2))>0</script><script type="math/tex; mode=display">
\lVert x\rVert (cos(\theta_2)-m-cos(\theta_1))>0</script><p>注意这个减号，因为cos在$[0, \pi]$之间是单调递减的，这个作用大致也是相当于往$\theta$乘上一个大于1的数，来压缩相应边$\theta$的取值范围。</p>
<h1 id="ArcFace"><a href="#ArcFace" class="headerlink" title="ArcFace"></a>ArcFace</h1><p><a href="https://arxiv.org/pdf/1801.07698.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1801.07698.pdf</a><br>一样的配方，m放在了cos里面，间隔改成了：</p>
<script type="math/tex; mode=display">
\lVert x\rVert (cos(\theta_1 + m)-cos(\theta_2))>0</script><script type="math/tex; mode=display">
\lVert x\rVert (cos(\theta_2+m)-cos(\theta_1))>0</script><h1 id="几种Loss的区别"><a href="#几种Loss的区别" class="headerlink" title="几种Loss的区别"></a>几种Loss的区别</h1><p>ArcFace里面详细分析了几种修补版softmax的区别，并指出只有ArcFace这种方式能够保持间隔在每个$\theta_1, \theta_2​$保持一致。</p>
<p><img src="/2018/05/由人脸识别引发的Softmax改进/compare.png" alt="compare"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tensors.space/2018/05/CPP11/Cpp虚函数的意义/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阮明康">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阮明康">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/CPP11/Cpp虚函数的意义/" class="post-title-link" itemprop="url">C++虚函数的意义</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-05-07 17:00:37" itemprop="dateCreated datePublished" datetime="2018-05-07T17:00:37+08:00">2018-05-07</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/语言基础/" itemprop="url" rel="index"><span itemprop="name">语言基础</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/语言基础/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>下面以一个简单的例子说明virtual的作用，作为继承和多态的重要组件，如果没有虚函数，那么多态的实现将非常的困难。首先明确一点，类成员函数中this的类型取决于该函数定义的位置，在父类中，this的类型是父类，在子类中，this的类型是子类。比如父类A和B，父类有一个成员函数test(), 其函数体中通过this调用了test1, 如果子类没有override这个函数，那么子类中，test()函数体里面this的类型依然是父类的类型。我们看下面三个例子来理解这一点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line">//This function will be called from a thread</span><br><span class="line">class A&#123;</span><br><span class="line">public:</span><br><span class="line">    void test()&#123;</span><br><span class="line">        this-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">    void test1()&#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;I am base&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class B:public A</span><br><span class="line">&#123;</span><br><span class="line">    virtual void test1()&#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;I am Not Base&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  //Launch a thread</span><br><span class="line">  B b;</span><br><span class="line">  b.test();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">// 运行结果</span><br><span class="line">// I am base</span><br><span class="line">// I am base</span><br></pre></td></tr></table></figure></p>
<p>这个例子中，子类B没有覆盖A::test，因此test函数体内，this类型依然是<code>A*</code>，这就造成了b.test()调用的是A::test1()，这往往不是想要的结果。而如果加上virtual, 那么就能够调用到真正想要调用的函数了，看下面的改动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">class A&#123;</span><br><span class="line">public:</span><br><span class="line">    void test()&#123;</span><br><span class="line">        this-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">    virtual void test1()&#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;I am base&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class B:public A</span><br><span class="line">&#123;</span><br><span class="line">    virtual void test1()&#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;I am Not Base&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  B b;</span><br><span class="line">  b.test();</span><br><span class="line">  </span><br><span class="line">  A a;</span><br><span class="line">  a.test();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">// 运行结果</span><br><span class="line">// I am Not Base</span><br><span class="line">// I am base</span><br></pre></td></tr></table></figure></p>
<p>这个例子中，test1是虚函数，因此即使B没有覆盖test函数，this的编译时类型依然是<code>A*</code>，但是在调用this-&gt;test1()的时候会查找虚函数表，然后知道this实际类型应该是<code>B*</code>并调用B::test1()。具体要调用A::test1还是B::test1只能在运行时知道。注意哦，如果子类同时覆盖了调用的函数test，那么也是能够调用到想要的test1的，因为此时编译时this的类型就已经是<code>B*</code>了。看下面的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">class A&#123;</span><br><span class="line">public:</span><br><span class="line">    void test()&#123;</span><br><span class="line">        this-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">    void test1()&#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;I am base&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class B:public A</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    void test1()&#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;I am Not Base&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    void test()&#123;</span><br><span class="line">        this-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  B b;</span><br><span class="line">  b.test();</span><br><span class="line">  </span><br><span class="line">  A a;</span><br><span class="line">  a.test();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">// 运行结果</span><br><span class="line">// I am Not Base</span><br><span class="line">// I am base</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="阮明康">
            
              <p class="site-author-name" itemprop="name">阮明康</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.linkedin.com/in/ruanmk/" title="LinkedIn &rarr; https://www.linkedin.com/in/ruanmk/" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阮明康</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  



  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  
  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script>
  
    bookmark.loadBookmark();
  
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

  

  

</body>
</html>
